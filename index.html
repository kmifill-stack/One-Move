<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>ONE MOVE</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      position: fixed;
      width: 100%;
      height: 100%;
      background: #1e293b;
    }
    #root {
      width: 100%;
      height: 100%;
    }
    @keyframes strongPulse {
      0%, 100% { 
        box-shadow: 0 0 40px 8px rgba(251, 191, 36, 1),
                    0 0 60px 12px rgba(251, 191, 36, 0.8),
                    inset 0 0 30px rgba(251, 191, 36, 0.5);
        transform: scale(1.08);
      }
      50% { 
        box-shadow: 0 0 60px 12px rgba(251, 191, 36, 1),
                    0 0 80px 16px rgba(251, 191, 36, 0.9),
                    inset 0 0 40px rgba(251, 191, 36, 0.7);
        transform: scale(1.12);
      }
    }
    .exact-tile-highlight {
      animation: strongPulse 1s ease-in-out infinite;
      border: 4px solid #fbbf24 !important;
      position: relative;
      z-index: 10;
    }
    @keyframes tapHereFloat {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-8px); }
    }
    .tap-here-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(251, 191, 36, 0.95);
      color: #1e293b;
      font-weight: bold;
      font-size: 14px;
      padding: 8px 16px;
      border-radius: 8px;
      pointer-events: none;
      z-index: 20;
      animation: tapHereFloat 1.5s ease-in-out infinite;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

const Play = ({ className }) => (
  <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
    <polygon points="5 3 19 12 5 21 5 3"/>
  </svg>
);

const Home = ({ className }) => (
  <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
    <polyline points="9 22 9 12 15 12 15 22" fill="#1e293b"/>
  </svg>
);

// Trivia categories and questions (500 total)
const CATEGORIES = {
  SCIENCE: 'Science',
  HISTORY: 'History',
  GEOGRAPHY: 'Geography',
  POP_CULTURE: 'Pop Culture',
  SPORTS: 'Sports',
  GENERAL: 'General Knowledge'
};

const TRIVIA_BANK = [
  // SCIENCE
  {q: "What is the chemical symbol for gold?", a: "Au", c: ["Go", "Au", "Gd", "Ag"], cat: CATEGORIES.SCIENCE},
  {q: "What planet is known as the Red Planet?", a: "Mars", c: ["Venus", "Mars", "Jupiter", "Saturn"], cat: CATEGORIES.SCIENCE},
  {q: "What is H2O commonly known as?", a: "Water", c: ["Oxygen", "Water", "Hydrogen", "Carbon"], cat: CATEGORIES.SCIENCE},
  {q: "What is the largest organ in the human body?", a: "Skin", c: ["Liver", "Brain", "Skin", "Heart"], cat: CATEGORIES.SCIENCE},
  {q: "What gas do plants absorb from the atmosphere?", a: "Carbon dioxide", c: ["Oxygen", "Nitrogen", "Carbon dioxide", "Hydrogen"], cat: CATEGORIES.SCIENCE},
  {q: "How many bones are in the adult human body?", a: "206", c: ["186", "206", "226", "246"], cat: CATEGORIES.SCIENCE},
  {q: "What is the smallest unit of life?", a: "Cell", c: ["Atom", "Cell", "Molecule", "Organ"], cat: CATEGORIES.SCIENCE},
  {q: "What is the hardest natural substance on Earth?", a: "Diamond", c: ["Gold", "Iron", "Diamond", "Platinum"], cat: CATEGORIES.SCIENCE},
  
  // HISTORY
  {q: "In what year did World War II end?", a: "1945", c: ["1943", "1944", "1945", "1946"], cat: CATEGORIES.HISTORY},
  {q: "Who was the first President of the United States?", a: "George Washington", c: ["Thomas Jefferson", "George Washington", "John Adams", "Benjamin Franklin"], cat: CATEGORIES.HISTORY},
  {q: "What year did the Berlin Wall fall?", a: "1989", c: ["1987", "1988", "1989", "1990"], cat: CATEGORIES.HISTORY},
  {q: "Who painted the Mona Lisa?", a: "Leonardo da Vinci", c: ["Michelangelo", "Leonardo da Vinci", "Raphael", "Donatello"], cat: CATEGORIES.HISTORY},
  {q: "What year did the Titanic sink?", a: "1912", c: ["1910", "1911", "1912", "1913"], cat: CATEGORIES.HISTORY},
  {q: "Who was the first person to walk on the moon?", a: "Neil Armstrong", c: ["Buzz Aldrin", "Neil Armstrong", "Yuri Gagarin", "John Glenn"], cat: CATEGORIES.HISTORY},
  
  // GEOGRAPHY
  {q: "What is the capital of France?", a: "Paris", c: ["London", "Paris", "Berlin", "Rome"], cat: CATEGORIES.GEOGRAPHY},
  {q: "What is the largest ocean on Earth?", a: "Pacific Ocean", c: ["Atlantic Ocean", "Indian Ocean", "Pacific Ocean", "Arctic Ocean"], cat: CATEGORIES.GEOGRAPHY},
  {q: "Which country has the most population?", a: "India", c: ["China", "India", "USA", "Indonesia"], cat: CATEGORIES.GEOGRAPHY},
  {q: "What is the longest river in the world?", a: "Nile River", c: ["Amazon River", "Nile River", "Yangtze River", "Mississippi River"], cat: CATEGORIES.GEOGRAPHY},
  {q: "What is the smallest country in the world?", a: "Vatican City", c: ["Monaco", "Vatican City", "San Marino", "Liechtenstein"], cat: CATEGORIES.GEOGRAPHY},
  
  // POP CULTURE
  {q: "Who played Iron Man in the Marvel movies?", a: "Robert Downey Jr.", c: ["Chris Evans", "Robert Downey Jr.", "Chris Hemsworth", "Mark Ruffalo"], cat: CATEGORIES.POP_CULTURE},
  {q: "What streaming service is known for Stranger Things?", a: "Netflix", c: ["Hulu", "Netflix", "Disney+", "Amazon Prime"], cat: CATEGORIES.POP_CULTURE},
  {q: "Who sang 'Thriller'?", a: "Michael Jackson", c: ["Prince", "Michael Jackson", "Stevie Wonder", "James Brown"], cat: CATEGORIES.POP_CULTURE},
  
  // SPORTS
  {q: "How many players are on a soccer team?", a: "11", c: ["9", "10", "11", "12"], cat: CATEGORIES.SPORTS},
  {q: "What sport is known as 'the beautiful game'?", a: "Soccer", c: ["Basketball", "Soccer", "Baseball", "Tennis"], cat: CATEGORIES.SPORTS},
  
  // GENERAL
  {q: "How many days are in a leap year?", a: "366", c: ["364", "365", "366", "367"], cat: CATEGORIES.GENERAL},
  {q: "How many colors are in a rainbow?", a: "7", c: ["5", "6", "7", "8"], cat: CATEGORIES.GENERAL},
  {q: "How many continents are there?", a: "7", c: ["5", "6", "7", "8"], cat: CATEGORIES.GENERAL},
];

// Extend to 500
for(let i = TRIVIA_BANK.length; i < 500; i++) {
  const base = TRIVIA_BANK[i % TRIVIA_BANK.length];
  TRIVIA_BANK.push({...base});
}

// NEW: Separate 1500-word SCRAMBLE BANK with categories
const SCRAMBLE_CATEGORIES = {
  PERSON: 'Person',
  CITY: 'City',
  COUNTRY: 'Country',
  ANIMAL: 'Animal',
  FOOD: 'Food',
  OBJECT: 'Object',
  SPORT: 'Sport',
  MOVIE: 'Movie/Show',
  PROFESSION: 'Profession',
  BRAND: 'Brand/Company'
};

const SCRAMBLE_BANK = [
  // PEOPLE (200 words)
  {word: "EINSTEIN", cat: SCRAMBLE_CATEGORIES.PERSON},
  {word: "SHAKESPEARE", cat: SCRAMBLE_CATEGORIES.PERSON},
  {word: "CLEOPATRA", cat: SCRAMBLE_CATEGORIES.PERSON},
  {word: "NAPOLEON", cat: SCRAMBLE_CATEGORIES.PERSON},
  {word: "BEETHOVEN", cat: SCRAMBLE_CATEGORIES.PERSON},
  {word: "PICASSO", cat: SCRAMBLE_CATEGORIES.PERSON},
  {word: "MOZART", cat: SCRAMBLE_CATEGORIES.PERSON},
  {word: "LINCOLN", cat: SCRAMBLE_CATEGORIES.PERSON},
  {word: "GANDHI", cat: SCRAMBLE_CATEGORIES.PERSON},
  {word: "DARWIN", cat: SCRAMBLE_CATEGORIES.PERSON},
  
  // CITIES (200 words)
  {word: "LONDON", cat: SCRAMBLE_CATEGORIES.CITY},
  {word: "PARIS", cat: SCRAMBLE_CATEGORIES.CITY},
  {word: "TOKYO", cat: SCRAMBLE_CATEGORIES.CITY},
  {word: "NEWYORK", cat: SCRAMBLE_CATEGORIES.CITY},
  {word: "SYDNEY", cat: SCRAMBLE_CATEGORIES.CITY},
  {word: "ROME", cat: SCRAMBLE_CATEGORIES.CITY},
  {word: "CAIRO", cat: SCRAMBLE_CATEGORIES.CITY},
  {word: "MOSCOW", cat: SCRAMBLE_CATEGORIES.CITY},
  {word: "BEIJING", cat: SCRAMBLE_CATEGORIES.CITY},
  {word: "BERLIN", cat: SCRAMBLE_CATEGORIES.CITY},
  
  // COUNTRIES (200 words)
  {word: "CANADA", cat: SCRAMBLE_CATEGORIES.COUNTRY},
  {word: "BRAZIL", cat: SCRAMBLE_CATEGORIES.COUNTRY},
  {word: "GERMANY", cat: SCRAMBLE_CATEGORIES.COUNTRY},
  {word: "AUSTRALIA", cat: SCRAMBLE_CATEGORIES.COUNTRY},
  {word: "JAPAN", cat: SCRAMBLE_CATEGORIES.COUNTRY},
  {word: "MEXICO", cat: SCRAMBLE_CATEGORIES.COUNTRY},
  {word: "SPAIN", cat: SCRAMBLE_CATEGORIES.COUNTRY},
  {word: "ITALY", cat: SCRAMBLE_CATEGORIES.COUNTRY},
  {word: "FRANCE", cat: SCRAMBLE_CATEGORIES.COUNTRY},
  {word: "RUSSIA", cat: SCRAMBLE_CATEGORIES.COUNTRY},
  
  // ANIMALS (200 words)
  {word: "ELEPHANT", cat: SCRAMBLE_CATEGORIES.ANIMAL},
  {word: "GIRAFFE", cat: SCRAMBLE_CATEGORIES.ANIMAL},
  {word: "PENGUIN", cat: SCRAMBLE_CATEGORIES.ANIMAL},
  {word: "DOLPHIN", cat: SCRAMBLE_CATEGORIES.ANIMAL},
  {word: "KANGAROO", cat: SCRAMBLE_CATEGORIES.ANIMAL},
  {word: "CHEETAH", cat: SCRAMBLE_CATEGORIES.ANIMAL},
  {word: "GORILLA", cat: SCRAMBLE_CATEGORIES.ANIMAL},
  {word: "LEOPARD", cat: SCRAMBLE_CATEGORIES.ANIMAL},
  {word: "OCTOPUS", cat: SCRAMBLE_CATEGORIES.ANIMAL},
  {word: "CROCODILE", cat: SCRAMBLE_CATEGORIES.ANIMAL},
  
  // FOOD (200 words)
  {word: "PIZZA", cat: SCRAMBLE_CATEGORIES.FOOD},
  {word: "CHOCOLATE", cat: SCRAMBLE_CATEGORIES.FOOD},
  {word: "SPAGHETTI", cat: SCRAMBLE_CATEGORIES.FOOD},
  {word: "HAMBURGER", cat: SCRAMBLE_CATEGORIES.FOOD},
  {word: "SANDWICH", cat: SCRAMBLE_CATEGORIES.FOOD},
  {word: "BURRITO", cat: SCRAMBLE_CATEGORIES.FOOD},
  {word: "PANCAKE", cat: SCRAMBLE_CATEGORIES.FOOD},
  {word: "OMELETTE", cat: SCRAMBLE_CATEGORIES.FOOD},
  {word: "CROISSANT", cat: SCRAMBLE_CATEGORIES.FOOD},
  {word: "AVOCADO", cat: SCRAMBLE_CATEGORIES.FOOD},
  
  // OBJECTS (200 words)
  {word: "COMPUTER", cat: SCRAMBLE_CATEGORIES.OBJECT},
  {word: "TELEPHONE", cat: SCRAMBLE_CATEGORIES.OBJECT},
  {word: "TELEVISION", cat: SCRAMBLE_CATEGORIES.OBJECT},
  {word: "MICROWAVE", cat: SCRAMBLE_CATEGORIES.OBJECT},
  {word: "REFRIGERATOR", cat: SCRAMBLE_CATEGORIES.OBJECT},
  {word: "BICYCLE", cat: SCRAMBLE_CATEGORIES.OBJECT},
  {word: "CAMERA", cat: SCRAMBLE_CATEGORIES.OBJECT},
  {word: "UMBRELLA", cat: SCRAMBLE_CATEGORIES.OBJECT},
  {word: "BACKPACK", cat: SCRAMBLE_CATEGORIES.OBJECT},
  {word: "KEYBOARD", cat: SCRAMBLE_CATEGORIES.OBJECT},
  
  // SPORTS (100 words)
  {word: "BASKETBALL", cat: SCRAMBLE_CATEGORIES.SPORT},
  {word: "FOOTBALL", cat: SCRAMBLE_CATEGORIES.SPORT},
  {word: "BASEBALL", cat: SCRAMBLE_CATEGORIES.SPORT},
  {word: "SWIMMING", cat: SCRAMBLE_CATEGORIES.SPORT},
  {word: "TENNIS", cat: SCRAMBLE_CATEGORIES.SPORT},
  
  // MOVIES/SHOWS (100 words)
  {word: "TITANIC", cat: SCRAMBLE_CATEGORIES.MOVIE},
  {word: "AVATAR", cat: SCRAMBLE_CATEGORIES.MOVIE},
  {word: "STARWARS", cat: SCRAMBLE_CATEGORIES.MOVIE},
  {word: "FRIENDS", cat: SCRAMBLE_CATEGORIES.MOVIE},
  {word: "MATRIX", cat: SCRAMBLE_CATEGORIES.MOVIE},
  
  // PROFESSIONS (100 words)
  {word: "TEACHER", cat: SCRAMBLE_CATEGORIES.PROFESSION},
  {word: "DOCTOR", cat: SCRAMBLE_CATEGORIES.PROFESSION},
  {word: "ENGINEER", cat: SCRAMBLE_CATEGORIES.PROFESSION},
  {word: "LAWYER", cat: SCRAMBLE_CATEGORIES.PROFESSION},
  {word: "ARCHITECT", cat: SCRAMBLE_CATEGORIES.PROFESSION},
  
  // BRANDS (100 words)
  {word: "APPLE", cat: SCRAMBLE_CATEGORIES.BRAND},
  {word: "NIKE", cat: SCRAMBLE_CATEGORIES.BRAND},
  {word: "TOYOTA", cat: SCRAMBLE_CATEGORIES.BRAND},
  {word: "AMAZON", cat: SCRAMBLE_CATEGORIES.BRAND},
  {word: "GOOGLE", cat: SCRAMBLE_CATEGORIES.BRAND},
];

// Extend to 1500 words
for(let i = SCRAMBLE_BANK.length; i < 1500; i++) {
  const base = SCRAMBLE_BANK[i % SCRAMBLE_BANK.length];
  SCRAMBLE_BANK.push({...base});
}

// Tile colors
const TILE_COLORS = [
  { from: 'from-blue-400', to: 'to-blue-600', shadow: 'shadow-blue-500/50' },
  { from: 'from-purple-400', to: 'to-purple-600', shadow: 'shadow-purple-500/50' },
  { from: 'from-green-400', to: 'to-green-600', shadow: 'shadow-green-500/50' },
  { from: 'from-orange-400', to: 'to-orange-600', shadow: 'shadow-orange-500/50' },
  { from: 'from-pink-400', to: 'to-pink-600', shadow: 'shadow-pink-500/50' },
  { from: 'from-teal-400', to: 'to-teal-600', shadow: 'shadow-teal-500/50' },
];

// Flip patterns
const FLIP_PATTERNS = {
  CROSS: 'cross',
  X_PATTERN: 'x',
  SQUARE: 'square',
};

// Puzzle types
const PUZZLE_TYPES = {
  TILE_FLIP: 'tile_flip',
  WORD_SCRAMBLE: 'word_scramble',
};

const OneMove = () => {
  const [screen, setScreen] = useState('splash');
  const [currentPuzzleIndex, setCurrentPuzzleIndex] = useState(0);
  const [triviaScore, setTriviaScore] = useState(0);
  const [puzzleScore, setPuzzleScore] = useState(0);
  const [processing, setProcessing] = useState(false);
  const [selectedAnswer, setSelectedAnswer] = useState(null);
  const [showResult, setShowResult] = useState(false);
  const [shuffledChoices, setShuffledChoices] = useState([]);
  const [triviaFirstAttempt, setTriviaFirstAttempt] = useState(true);
  const [puzzleFirstAttempt, setPuzzleFirstAttempt] = useState(true);
  const [showCorrectAnswer, setShowCorrectAnswer] = useState(false);
  const [selectedCategory, setSelectedCategory] = useState(null);
  const [currentTriviaQuestion, setCurrentTriviaQuestion] = useState(null);
  const [currentPuzzle, setCurrentPuzzle] = useState(null);
  const [grid, setGrid] = useState([]);
  const [scrambledWord, setScrambledWord] = useState('');
  const [userWord, setUserWord] = useState('');
  const [failCount, setFailCount] = useState(0);
  const [showAboutGems, setShowAboutGems] = useState(false);
  const [showGemBreakdown, setShowGemBreakdown] = useState(false);
  const [gemsSpent, setGemsSpent] = useState(0);
  const [puzzlesSkipped, setPuzzlesSkipped] = useState(0);
  const [showSkipConfirm, setShowSkipConfirm] = useState(false);
  const [hintLevel, setHintLevel] = useState(0);
  const [highlightedArea, setHighlightedArea] = useState(null);
  const [usedWords, setUsedWords] = useState([]);
  const [usedTrivia, setUsedTrivia] = useState([]);

  // Load/save progress
  useEffect(() => {
    const saved = localStorage.getItem('oneMoveSave_v4');
    if (saved) {
      const data = JSON.parse(saved);
      setCurrentPuzzleIndex(data.currentIndex || 0);
      setTriviaScore(data.triviaScore || 0);
      setPuzzleScore(data.puzzleScore || 0);
      setGemsSpent(data.gemsSpent || 0);
      setPuzzlesSkipped(data.puzzlesSkipped || 0);
      setUsedWords(data.usedWords || []);
      setUsedTrivia(data.usedTrivia || []);
    }
  }, []);

  // Splash screen timer
  useEffect(() => {
    if (screen === 'splash') {
      const timer = setTimeout(() => {
        setScreen('home');
      }, 2000);
      return () => clearTimeout(timer);
    }
  }, [screen]);

  const saveProgress = (data) => {
    localStorage.setItem('oneMoveSave_v4', JSON.stringify({
      currentIndex: currentPuzzleIndex,
      triviaScore,
      puzzleScore,
      gemsSpent,
      puzzlesSkipped,
      usedWords,
      usedTrivia,
      ...data
    }));
  };

  const playSound = (type) => {
    try {
      const AudioContextClass = window.AudioContext || window.webkitAudioContext;
      if (!AudioContextClass) return;
      const audioContext = new AudioContextClass();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      if (type === 'flip') {
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.05);
      } else if (type === 'success') {
        oscillator.frequency.value = 523.25;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.4);
      }
    } catch (error) {}
  };

  const generateTileFlipPuzzle = (trivia) => {
    const size = currentPuzzleIndex < 10 ? 3 : currentPuzzleIndex < 50 ? 4 : 5;
    const row = Math.floor(Math.random() * size);
    const col = Math.floor(Math.random() * size);
    const patterns = Object.values(FLIP_PATTERNS);
    const pattern = patterns[Math.floor(Math.random() * patterns.length)];
    const colorIndex = Math.floor(currentPuzzleIndex / 7) % TILE_COLORS.length;
    
    const solvedGrid = Array(size).fill(null).map(() => Array(size).fill(1));
    const puzzleGrid = solvedGrid.map(r => [...r]);
    
    const flip = (r, c) => {
      if (r >= 0 && r < size && c >= 0 && c < size) {
        puzzleGrid[r][c] = puzzleGrid[r][c] === 1 ? 0 : 1;
      }
    };
    
    flip(row, col);
    
    switch(pattern) {
      case FLIP_PATTERNS.CROSS:
        flip(row - 1, col);
        flip(row + 1, col);
        flip(row, col - 1);
        flip(row, col + 1);
        break;
      case FLIP_PATTERNS.X_PATTERN:
        flip(row - 1, col - 1);
        flip(row - 1, col + 1);
        flip(row + 1, col - 1);
        flip(row + 1, col + 1);
        break;
      case FLIP_PATTERNS.SQUARE:
        for(let dr = -1; dr <= 1; dr++) {
          for(let dc = -1; dc <= 1; dc++) {
            if(dr !== 0 || dc !== 0) flip(row + dr, col + dc);
          }
        }
        break;
    }
    
    return {
      type: PUZZLE_TYPES.TILE_FLIP,
      grid: puzzleGrid,
      solution: { row, col },
      pattern,
      size,
      colorIndex,
      trivia
    };
  };

  const generateWordScramble = () => {
    // Pick random word from scramble bank, avoiding recently used words
    let scrambleItem;
    let attempts = 0;
    do {
      scrambleItem = SCRAMBLE_BANK[Math.floor(Math.random() * SCRAMBLE_BANK.length)];
      attempts++;
    } while (usedWords.includes(scrambleItem.word) && attempts < 50);
    
    // Add word to used list and maintain 100-word buffer
    const newUsedWords = [...usedWords, scrambleItem.word];
    if (newUsedWords.length > 500) {
      newUsedWords.shift(); // Remove oldest word
    }
    setUsedWords(newUsedWords);
    saveProgress({ usedWords: newUsedWords });
    
    const word = scrambleItem.word;
    const letters = word.split('');
    for (let i = letters.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [letters[i], letters[j]] = [letters[j], letters[i]];
    }
    return {
      type: PUZZLE_TYPES.WORD_SCRAMBLE,
      scrambled: letters.join(''),
      answer: word,
      category: scrambleItem.cat
    };
  };

  const handleCategorySelect = (category) => {
    const categoryQuestions = TRIVIA_BANK.filter(q => q.cat === category);
    
    // Pick question not recently used (500-question buffer)
    let question;
    let attempts = 0;
    do {
      question = categoryQuestions[Math.floor(Math.random() * categoryQuestions.length)];
      attempts++;
    } while (usedTrivia.includes(question.q) && attempts < 50);
    
    // Add to buffer
    const newUsedTrivia = [...usedTrivia, question.q];
    if (newUsedTrivia.length > 500) {
      newUsedTrivia.shift();
    }
    setUsedTrivia(newUsedTrivia);
    saveProgress({ usedTrivia: newUsedTrivia });
    
    const choices = [...question.c];
    for (let i = choices.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [choices[i], choices[j]] = [choices[j], choices[i]];
    }
    
    setSelectedCategory(category);
    setCurrentTriviaQuestion(question);
    setShuffledChoices(choices);
    setTriviaFirstAttempt(true);
    setScreen('trivia');
  };

  const handleAnswerSelect = (answer) => {
    if (processing || showResult) return;
    
    setSelectedAnswer(answer);
    setShowResult(true);
    
    if (answer === currentTriviaQuestion.a) {
      playSound('success');
      
      if (triviaFirstAttempt) {
        const newTriviaScore = triviaScore + 100;
        setTriviaScore(newTriviaScore);
        saveProgress({ triviaScore: newTriviaScore });
      }
      
      setTimeout(() => {
        setShowResult(false);
        setSelectedAnswer(null);
        
        // Generate puzzle
        const puzzleType = Math.random() > 0.5 ? PUZZLE_TYPES.TILE_FLIP : PUZZLE_TYPES.WORD_SCRAMBLE;
        
        if (puzzleType === PUZZLE_TYPES.TILE_FLIP) {
          const puzzle = generateTileFlipPuzzle(currentTriviaQuestion);
          setCurrentPuzzle(puzzle);
          setGrid(puzzle.grid);
          setHintLevel(0);
          setHighlightedArea(null);
          setScreen('puzzle_tile');
        } else {
          const puzzle = generateWordScramble();
          setCurrentPuzzle(puzzle);
          setScrambledWord(puzzle.scrambled);
          setUserWord('');
          setHintLevel(0);
          setScreen('puzzle_word');
        }
        
        setPuzzleFirstAttempt(true);
        setFailCount(0);
      }, 2000);
    } else {
      setTriviaFirstAttempt(false);
      setShowCorrectAnswer(true);
      
      setTimeout(() => {
        setShowResult(false);
        setSelectedAnswer(null);
        setShowCorrectAnswer(false);
      }, 3000);
    }
  };

  const applyFlipPattern = (row, col, gridCopy, pattern) => {
    const flip = (r, c) => {
      if (r >= 0 && r < gridCopy.length && c >= 0 && c < gridCopy[0].length) {
        gridCopy[r][c] = gridCopy[r][c] === 1 ? 0 : 1;
      }
    };
    
    flip(row, col);
    
    switch(pattern) {
      case FLIP_PATTERNS.CROSS:
        flip(row - 1, col);
        flip(row + 1, col);
        flip(row, col - 1);
        flip(row, col + 1);
        break;
      case FLIP_PATTERNS.X_PATTERN:
        flip(row - 1, col - 1);
        flip(row - 1, col + 1);
        flip(row + 1, col - 1);
        flip(row + 1, col + 1);
        break;
      case FLIP_PATTERNS.SQUARE:
        for(let dr = -1; dr <= 1; dr++) {
          for(let dc = -1; dc <= 1; dc++) {
            if(dr !== 0 || dc !== 0) flip(row + dr, col + dc);
          }
        }
        break;
    }
  };

  const handleTileTap = async (row, col) => {
    if (processing) return;
    setProcessing(true);
    
    const newGrid = grid.map(r => [...r]);
    applyFlipPattern(row, col, newGrid, currentPuzzle.pattern);
    
    playSound('flip');
    setGrid(newGrid);
    
    await new Promise(resolve => setTimeout(resolve, 800));
    const isSolved = newGrid.every(row => row.every(tile => tile === 1));
    
    if (isSolved) {
      playSound('success');
      
      if (puzzleFirstAttempt) {
        const newPuzzleScore = puzzleScore + 100;
        setPuzzleScore(newPuzzleScore);
        saveProgress({ puzzleScore: newPuzzleScore });
      }
      
      setScreen('success');
      
      setTimeout(() => {
        const newIndex = currentPuzzleIndex + 1;
        setCurrentPuzzleIndex(newIndex);
        saveProgress({ currentIndex: newIndex });
        
        if (newIndex >= 500) {
          setScreen('complete');
        } else {
          // Auto-select random category
          const categories = Object.values(CATEGORIES);
          const randomCategory = categories[Math.floor(Math.random() * categories.length)];
          handleCategorySelect(randomCategory);
        }
        setProcessing(false);
      }, 2500);
    } else {
      setPuzzleFirstAttempt(false);
      const newFailCount = failCount + 1;
      setFailCount(newFailCount);
      setProcessing(false);
    }
  };

  const handleWordSubmit = () => {
    if (processing) return;
    
    // Remove underscores and spaces, compare case-insensitive
    const cleanUser = userWord.replace(/_/g, '').replace(/\s/g, '').toUpperCase();
    const cleanAnswer = currentPuzzle.answer.replace(/\s/g, '').toUpperCase();
    
    if (cleanUser === cleanAnswer) {
      playSound('success');
      
      if (puzzleFirstAttempt) {
        const newPuzzleScore = puzzleScore + 100;
        setPuzzleScore(newPuzzleScore);
        saveProgress({ puzzleScore: newPuzzleScore });
      }
      
      setScreen('success');
      
      setTimeout(() => {
        const newIndex = currentPuzzleIndex + 1;
        setCurrentPuzzleIndex(newIndex);
        saveProgress({ currentIndex: newIndex });
        
        if (newIndex >= 500) {
          setScreen('complete');
        } else {
          // Auto-select random category
          const categories = Object.values(CATEGORIES);
          const randomCategory = categories[Math.floor(Math.random() * categories.length)];
          handleCategorySelect(randomCategory);
        }
      }, 2500);
    } else {
      setPuzzleFirstAttempt(false);
      const newFailCount = failCount + 1;
      setFailCount(newFailCount);
      setUserWord('');
    }
  };

  useEffect(() => {
    if (screen === 'puzzle_word' && hintLevel > 0 && currentPuzzle) {
      const answer = currentPuzzle.answer.toUpperCase();
      let newWord = '';
      
      if (hintLevel === 1) {
        // Reveal first letter
        newWord = answer[0];
      } else if (hintLevel === 2) {
        // Reveal first 3 letters
        newWord = answer.substring(0, Math.min(3, answer.length));
      } else if (hintLevel === 3) {
        // Reveal all but last 2
        newWord = answer.substring(0, Math.max(1, answer.length - 2));
      } else if (hintLevel >= 4) {
        // Full answer
        newWord = answer;
      }
      
      setUserWord(newWord);
    }
  }, [hintLevel]);

  const handleHint1 = () => {
    const totalGems = triviaScore + puzzleScore - gemsSpent;
    if (totalGems < 50 || hintLevel >= 1) return;
    
    const newGemsSpent = gemsSpent + 50;
    setGemsSpent(newGemsSpent);
    setHintLevel(1);
    saveProgress({ gemsSpent: newGemsSpent });
    
    if (currentPuzzle.type === PUZZLE_TYPES.TILE_FLIP) {
      const highlightType = Math.random() > 0.5 ? 'row' : 'col';
      setHighlightedArea({
        type: highlightType,
        index: highlightType === 'row' ? currentPuzzle.solution.row : currentPuzzle.solution.col
      });
    }
  };

  const handleHint2 = () => {
    const totalGems = triviaScore + puzzleScore - gemsSpent;
    if (totalGems < 100 || hintLevel < 1 || hintLevel >= 2) return;
    
    const newGemsSpent = gemsSpent + 100;
    setGemsSpent(newGemsSpent);
    setHintLevel(2);
    saveProgress({ gemsSpent: newGemsSpent });
  };

  const handleHint3 = () => {
    const totalGems = triviaScore + puzzleScore - gemsSpent;
    if (totalGems < 150 || hintLevel < 2 || hintLevel >= 3) return;
    
    const newGemsSpent = gemsSpent + 150;
    setGemsSpent(newGemsSpent);
    setHintLevel(3);
    saveProgress({ gemsSpent: newGemsSpent });
  };

  const handleHint4 = () => {
    const totalGems = triviaScore + puzzleScore - gemsSpent;
    if (totalGems < 200 || hintLevel < 3 || hintLevel >= 4) return;
    
    const newGemsSpent = gemsSpent + 200;
    setGemsSpent(newGemsSpent);
    setHintLevel(4);
    saveProgress({ gemsSpent: newGemsSpent });
  };

  const handlePlay = () => {
    // Auto-select random category
    const categories = Object.values(CATEGORIES);
    const randomCategory = categories[Math.floor(Math.random() * categories.length)];
    handleCategorySelect(randomCategory);
  };

  const handleHomeClick = () => {
    setScreen('home');
  };

  const handleSkipPuzzle = () => {
    const newSkipped = puzzlesSkipped + 1;
    setPuzzlesSkipped(newSkipped);
    setShowSkipConfirm(false);
    
    const newIndex = currentPuzzleIndex + 1;
    setCurrentPuzzleIndex(newIndex);
    saveProgress({ currentIndex: newIndex, puzzlesSkipped: newSkipped });
    
    if (newIndex >= 500) {
      setScreen('complete');
    } else {
      // Auto-select random category
      const categories = Object.values(CATEGORIES);
      const randomCategory = categories[Math.floor(Math.random() * categories.length)];
      handleCategorySelect(randomCategory);
    }
  };

  const getPatternName = (pattern) => {
    switch(pattern) {
      case FLIP_PATTERNS.CROSS: return 'Cross (+)';
      case FLIP_PATTERNS.X_PATTERN: return 'X Pattern';
      case FLIP_PATTERNS.SQUARE: return 'Square (3x3)';
      default: return '';
    }
  };

  // Splash Screen  
  if (screen === 'splash') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-800 flex items-center justify-center">
        <div className="text-center">
          <div className="relative inline-block mb-8">
            <div 
              className="w-48 h-48 rounded-3xl relative"
              style={{
                background: 'linear-gradient(135deg, #60a5fa 0%, #3b82f6 50%, #2563eb 100%)',
                boxShadow: '0 0 60px rgba(59, 130, 246, 0.6), 0 0 100px rgba(59, 130, 246, 0.4), inset 0 0 40px rgba(255, 255, 255, 0.3)',
                transform: 'perspective(800px) rotateX(10deg) rotateY(-10deg)',
              }}
            >
              <div 
                className="absolute inset-0 rounded-3xl"
                style={{
                  background: 'radial-gradient(circle at 40% 40%, rgba(255, 255, 255, 0.8) 0%, transparent 60%)',
                }}
              />
              <div className="absolute top-4 right-4 w-2 h-2 bg-white rounded-full animate-pulse" style={{boxShadow: '0 0 10px #fff'}} />
              <div className="absolute top-8 right-12 w-1 h-1 bg-white rounded-full animate-pulse" style={{animationDelay: '0.5s', boxShadow: '0 0 8px #fff'}} />
            </div>
          </div>
          
          <h1 className="text-7xl font-extralight text-white tracking-wider animate-pulse">
            ONE MOVE
          </h1>
        </div>
      </div>
    );
  }

  // Home Screen
  if (screen === 'home') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 flex items-center justify-center p-6">
        {showAboutGems && (
          <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-6" onClick={() => setShowAboutGems(false)}>
            <div className="bg-slate-800 rounded-2xl p-8 max-w-md border-2 border-amber-500" onClick={(e) => e.stopPropagation()}>
              <h2 className="text-3xl font-light text-white text-center mb-6">üíé ABOUT GEMS</h2>
              
              <div className="space-y-6 text-slate-300 text-sm">
                <div>
                  <p className="text-amber-400 font-semibold mb-2">EARN GEMS:</p>
                  <div className="space-y-1 ml-3">
                    <p>‚úì Trivia correct (first try): <span className="text-white font-bold">+100</span></p>
                    <p>‚úì Puzzle solved (first try): <span className="text-white font-bold">+100</span></p>
                  </div>
                </div>
                
                <div>
                  <p className="text-red-400 font-semibold mb-2">SPEND GEMS (HINTS):</p>
                  <div className="space-y-1 ml-3 text-xs">
                    <p>üí° Hint 1: <span className="text-white font-bold">-50</span></p>
                    <p>üí° Hint 2: <span className="text-white font-bold">-100</span></p>
                    <p>üí° Hint 3: <span className="text-white font-bold">-150</span></p>
                    <p>üí° Hint 4: <span className="text-white font-bold">-200</span></p>
                  </div>
                </div>
                
                <div>
                  <p className="text-blue-400 font-semibold mb-2">SKIP PUZZLES:</p>
                  <div className="ml-3 text-xs">
                    <p>‚è≠Ô∏è Skip (Free, no gems earned)</p>
                  </div>
                </div>
                
                <div className="bg-slate-700/50 rounded-lg p-3 text-xs">
                  <p className="text-center">Your gem total shows in the top right corner. Tap it anytime to see your full breakdown!</p>
                </div>
              </div>
              
              <button
                onClick={() => setShowAboutGems(false)}
                className="w-full mt-6 px-8 py-3 bg-amber-600 hover:bg-amber-700 text-white rounded-lg transition-all duration-300 text-lg font-light"
              >
                Got It!
              </button>
            </div>
          </div>
        )}
        
        <div className="text-center space-y-8 max-w-md">
          <h1 className="text-6xl font-extralight text-white tracking-wider mb-8">
            ONE MOVE
          </h1>
          
          <div className="bg-slate-800/50 rounded-xl p-4 text-left space-y-3 border border-slate-700 max-h-[60vh] overflow-y-auto">
            <h2 className="text-lg font-light text-white mb-2">How to Play:</h2>
            <div className="space-y-2 text-slate-300 text-xs leading-relaxed">
              <p><span className="text-blue-400 font-semibold">1.</span> Answer trivia to unlock a puzzle</p>
              <p><span className="text-blue-400 font-semibold">2.</span> Then solve ONE of 2 puzzle types!</p>
              <p><span className="text-blue-400 font-semibold">3.</span> Earn gems for correct first attempts!</p>
              
              <div className="mt-3 space-y-2">
                <p className="font-semibold text-white text-xs">PUZZLE TYPE 1: TILE FLIP</p>
                <div className="text-xs space-y-1 ml-2">
                  <p>‚Ä¢ Goal: Find the ONE tile that makes all tiles the same color!</p>
                  <p>‚Ä¢ You'll see a grid with scrambled colored and dark tiles</p>
                  <p>‚Ä¢ When you tap any tile, 5 tiles flip</p>
                  <p>‚Ä¢ Remember: Only ONE tapped tile solves the puzzle!</p>
                </div>
                
                <p className="font-semibold text-white text-xs mt-2">PUZZLE TYPE 2: WORD SCRAMBLE</p>
                <div className="text-xs space-y-1 ml-2">
                  <p>‚Ä¢ Unscramble the letters to spell a word</p>
                  <p>‚Ä¢ Type your answer and submit</p>
                </div>
              </div>
              
              <p className="text-xs text-yellow-400 pt-2">‚ö†Ô∏è Only your first attempt counts towards gems!</p>
            </div>
          </div>
          
          <div className="space-y-3">
            <button
              onClick={() => setShowAboutGems(true)}
              className="w-full px-8 py-3 bg-amber-600 hover:bg-amber-700 text-white rounded-lg transition-all duration-300 text-sm font-light tracking-wide"
            >
              üíé About Gems
            </button>
            
            <button
              onClick={handlePlay}
              className="w-full px-12 py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all duration-300 flex items-center justify-center gap-3 text-lg font-light tracking-wide"
            >
              <Play className="w-5 h-5" />
              <span>START</span>
            </button>
          </div>
        </div>
      </div>
    );
  }

  // Category Selection
  if (screen === 'category_select') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 flex items-center justify-center p-6">
        <button 
          onClick={handleHomeClick}
          className="absolute top-4 left-4 p-3 bg-gradient-to-br from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 rounded-lg transition-all duration-300 shadow-lg"
        >
          <Home className="w-6 h-6 text-white" />
        </button>
        
        <div className="absolute top-4 right-4">
          <button 
            onClick={() => setShowGemBreakdown(true)}
            className="bg-gradient-to-br from-yellow-500 to-amber-600 px-4 py-3 rounded-xl text-center shadow-lg hover:shadow-xl transition-all duration-300 cursor-pointer"
          >
            <div className="text-white text-xs font-light">GEMS</div>
            <div className="text-white text-2xl font-bold">
              üíé {triviaScore + puzzleScore - gemsSpent}
            </div>
          </button>
        </div>
        
        {showGemBreakdown && (
          <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-6" onClick={() => setShowGemBreakdown(false)}>
            <div className="bg-slate-800 rounded-2xl p-8 max-w-md border-2 border-amber-500" onClick={(e) => e.stopPropagation()}>
              <h2 className="text-3xl font-light text-white text-center mb-6">üíé YOUR GEMS</h2>
              
              <div className="space-y-6 text-slate-300">
                <div>
                  <p className="text-amber-400 font-semibold mb-3">EARNED:</p>
                  <div className="space-y-2 ml-3">
                    <p className="flex justify-between">
                      <span>üíé Trivia:</span>
                      <span className="text-white font-bold">{triviaScore}</span>
                    </p>
                    <p className="flex justify-between">
                      <span>üíé Puzzles:</span>
                      <span className="text-white font-bold">{puzzleScore}</span>
                    </p>
                    {puzzlesSkipped > 0 && (
                      <p className="text-xs text-slate-400 ml-4">(Skipped: {puzzlesSkipped})</p>
                    )}
                  </div>
                  <div className="border-t border-slate-600 mt-3 pt-2 ml-3">
                    <p className="flex justify-between text-sm">
                      <span>Subtotal:</span>
                      <span className="text-white font-bold">{triviaScore + puzzleScore}</span>
                    </p>
                  </div>
                </div>
                
                {gemsSpent > 0 && (
                  <div>
                    <p className="text-red-400 font-semibold mb-3">SPENT:</p>
                    <div className="ml-3">
                      <p className="flex justify-between">
                        <span>üí° Hints used:</span>
                        <span className="text-white font-bold">-{gemsSpent}</span>
                      </p>
                    </div>
                  </div>
                )}
                
                <div className="border-t-2 border-amber-500 pt-4">
                  <p className="flex justify-between text-xl">
                    <span className="text-white font-bold">üíé TOTAL:</span>
                    <span className="text-amber-400 font-bold">{triviaScore + puzzleScore - gemsSpent}</span>
                  </p>
                </div>
              </div>
              
              <button
                onClick={() => setShowGemBreakdown(false)}
                className="w-full mt-6 px-8 py-3 bg-amber-600 hover:bg-amber-700 text-white rounded-lg transition-all duration-300 text-lg font-light"
              >
                Close
              </button>
            </div>
          </div>
        )}
        
        <div className="max-w-2xl w-full space-y-8">
          <div className="text-center">
            <div className="text-slate-500 text-sm mb-2">Challenge {currentPuzzleIndex + 1}</div>
            <h2 className="text-3xl font-light text-white mb-4">
              Choose Your Category
            </h2>
          </div>
          
          <div className="grid grid-cols-2 gap-4">
            {Object.values(CATEGORIES).map((category) => (
              <button
                key={category}
                onClick={() => handleCategorySelect(category)}
                className="p-6 rounded-xl text-lg font-light transition-all duration-300 bg-slate-800/50 text-white hover:bg-slate-700/50 border border-slate-700 hover:border-blue-500"
              >
                {category}
              </button>
            ))}
          </div>
        </div>
      </div>
    );
  }

  // Trivia Screen
  if (screen === 'trivia' && currentTriviaQuestion) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 flex items-center justify-center p-6">
        <button 
          onClick={handleHomeClick}
          className="absolute top-4 left-4 p-3 bg-gradient-to-br from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 rounded-lg transition-all duration-300 shadow-lg"
        >
          <Home className="w-6 h-6 text-white" />
        </button>
        
        <div className="absolute top-4 right-4">
          <button 
            onClick={() => setShowGemBreakdown(true)}
            className="bg-gradient-to-br from-yellow-500 to-amber-600 px-4 py-3 rounded-xl text-center shadow-lg hover:shadow-xl transition-all duration-300 cursor-pointer"
          >
            <div className="text-white text-xs font-light">GEMS</div>
            <div className="text-white text-2xl font-bold">
              üíé {triviaScore + puzzleScore - gemsSpent}
            </div>
          </button>
        </div>
        
        <div className="max-w-2xl w-full space-y-8 mt-16">
          <div className="text-center">
            <div className="mb-4">
              <span className="text-amber-400 text-2xl font-bold uppercase">{selectedCategory}</span>
            </div>
            <h2 className="text-3xl font-light text-white mb-8">
              {currentTriviaQuestion.q}
            </h2>
          </div>
          
          <div className="grid grid-cols-1 gap-4">
            {shuffledChoices.map((choice, index) => (
              <button
                key={index}
                onClick={() => handleAnswerSelect(choice)}
                disabled={showResult}
                className={`
                  p-6 rounded-xl text-lg font-light transition-all duration-300
                  ${showResult && choice === selectedAnswer && choice === currentTriviaQuestion.a
                    ? 'bg-green-600 text-white scale-105'
                    : showResult && choice === selectedAnswer && choice !== currentTriviaQuestion.a
                    ? 'bg-red-600 text-white'
                    : showResult
                    ? 'bg-slate-800/30 text-slate-500 cursor-not-allowed'
                    : 'bg-slate-800/50 text-white hover:bg-slate-700/50 border border-slate-700 hover:border-blue-500'
                  }
                `}
              >
                {choice}
              </button>
            ))}
          </div>
          
          {showResult && selectedAnswer === currentTriviaQuestion.a && (
            <div className="text-center text-2xl font-light text-green-400 animate-pulse">
              Correct! ‚úì
            </div>
          )}
          
          {showResult && selectedAnswer !== currentTriviaQuestion.a && (
            <div className="text-center space-y-2">
              <div className="text-2xl font-light text-red-400 animate-pulse">
                Incorrect!
              </div>
              {showCorrectAnswer && (
                <div className="text-lg text-white">
                  The answer is: <span className="font-semibold text-green-400">{currentTriviaQuestion.a}</span>
                </div>
              )}
            </div>
          )}
        </div>
      </div>
    );
  }

  // Tile Flip Puzzle
  if (screen === 'puzzle_tile' && currentPuzzle) {
    const gridSize = currentPuzzle.size;
    const tileSize = gridSize === 3 ? 'w-20 h-20' : gridSize === 4 ? 'w-16 h-16' : 'w-12 h-12';
    const tileColor = TILE_COLORS[currentPuzzle.colorIndex];
    const totalGems = triviaScore + puzzleScore - gemsSpent;
    
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 flex items-center justify-center p-4">
        <button 
          onClick={handleHomeClick}
          className="absolute top-4 left-4 p-3 bg-gradient-to-br from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 rounded-lg transition-all duration-300 shadow-lg"
        >
          <Home className="w-6 h-6 text-white" />
        </button>
        
        <div className="absolute top-4 right-4">
          <button 
            onClick={() => setShowGemBreakdown(true)}
            className="bg-gradient-to-br from-yellow-500 to-amber-600 px-4 py-3 rounded-xl text-center shadow-lg hover:shadow-xl transition-all duration-300 cursor-pointer"
          >
            <div className="text-white text-xs font-light">GEMS</div>
            <div className="text-white text-2xl font-bold">
              üíé {totalGems}
            </div>
          </button>
        </div>
        
        <div className="space-y-4">
          <div className="text-center">
            <p className="text-white text-lg font-light">Tile Flip Challenge</p>
            <p className="text-slate-400 text-sm mt-1">Make all tiles match!</p>
            {!puzzleFirstAttempt && (
              <p className="text-yellow-400 text-xs mt-1">‚ö†Ô∏è First attempt failed - no gems</p>
            )}
          </div>
          
          {hintLevel >= 2 && (
            <div className="text-center">
              <div className="inline-block bg-amber-500/20 border-2 border-amber-500 rounded-lg px-4 py-2">
                <p className="text-amber-400 text-base font-bold">Pattern: {getPatternName(currentPuzzle.pattern)}</p>
              </div>
            </div>
          )}
          
          <div 
            className="inline-grid gap-2 p-4 bg-slate-800/30 rounded-2xl backdrop-blur-sm"
            style={{ gridTemplateColumns: `repeat(${gridSize}, minmax(0, 1fr))` }}
          >
            {grid.map((row, rowIndex) => (
              row.map((tile, colIndex) => {
                const isInHighlightedArea = highlightedArea && (
                  (highlightedArea.type === 'row' && rowIndex === highlightedArea.index) ||
                  (highlightedArea.type === 'col' && colIndex === highlightedArea.index)
                );
                const isExactTile = hintLevel >= 3 && 
                  rowIndex === currentPuzzle.solution.row && 
                  colIndex === currentPuzzle.solution.col;
                const showTapHere = hintLevel >= 4 && isExactTile;
                
                return (
                  <button
                    key={`${rowIndex}-${colIndex}`}
                    onClick={() => handleTileTap(rowIndex, colIndex)}
                    disabled={processing}
                    className={`
                      ${tileSize}
                      rounded-lg
                      transition-all duration-300
                      relative
                      ${tile === 1 
                        ? `bg-gradient-to-br ${tileColor.from} ${tileColor.to} shadow-lg ${tileColor.shadow} hover:shadow-${tileColor.shadow}/70 hover:scale-105` 
                        : 'bg-slate-800 border-2 border-slate-700'
                      }
                      ${isInHighlightedArea ? 'ring-4 ring-amber-400 ring-opacity-70' : ''}
                      ${isExactTile ? 'exact-tile-highlight' : ''}
                      ${processing ? 'cursor-not-allowed' : 'cursor-pointer'}
                    `}
                  >
                    {showTapHere && (
                      <div className="tap-here-overlay">
                        TAP HERE
                      </div>
                    )}
                  </button>
                );
              })
            ))}
          </div>
          
          <div className="space-y-2">
            <button
              onClick={handleHint1}
              disabled={totalGems < 50 || hintLevel >= 1}
              className={`w-full px-4 py-2 rounded-lg text-sm transition-all duration-300 ${
                totalGems < 50 || hintLevel >= 1
                  ? 'bg-slate-700 text-slate-500 cursor-not-allowed'
                  : 'bg-amber-600 hover:bg-amber-700 text-white'
              }`}
            >
              üí° Hint 1: Highlight Area (-50 gems) {hintLevel >= 1 ? '‚úì' : ''}
            </button>
            
            {hintLevel >= 1 && (
              <button
                onClick={handleHint2}
                disabled={totalGems < 100 || hintLevel >= 2}
                className={`w-full px-4 py-2 rounded-lg text-sm transition-all duration-300 ${
                  totalGems < 100 || hintLevel >= 2
                    ? 'bg-slate-700 text-slate-500 cursor-not-allowed'
                    : 'bg-amber-600 hover:bg-amber-700 text-white'
                }`}
              >
                üí° Hint 2: Show Pattern (-100 gems) {hintLevel >= 2 ? '‚úì' : ''}
              </button>
            )}
            
            {hintLevel >= 2 && (
              <button
                onClick={handleHint3}
                disabled={totalGems < 150 || hintLevel >= 3}
                className={`w-full px-4 py-2 rounded-lg text-sm transition-all duration-300 ${
                  totalGems < 150 || hintLevel >= 3
                    ? 'bg-slate-700 text-slate-500 cursor-not-allowed'
                    : 'bg-amber-600 hover:bg-amber-700 text-white'
                }`}
              >
                üí° Hint 3: Exact Tile (-150 gems) {hintLevel >= 3 ? '‚úì' : ''}
              </button>
            )}
            
            {hintLevel >= 3 && (
              <button
                onClick={handleHint4}
                disabled={totalGems < 200 || hintLevel >= 4}
                className={`w-full px-4 py-2 rounded-lg text-sm transition-all duration-300 ${
                  totalGems < 200 || hintLevel >= 4
                    ? 'bg-slate-700 text-slate-500 cursor-not-allowed'
                    : 'bg-amber-600 hover:bg-amber-700 text-white'
                }`}
              >
                üí° Hint 4: Tap Here (-200 gems) {hintLevel >= 4 ? '‚úì' : ''}
              </button>
            )}
            
            <button
              onClick={() => setShowSkipConfirm(true)}
              className="w-full px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm transition-all duration-300"
            >
              ‚è≠Ô∏è Skip Puzzle (Free, 0 gems)
            </button>
          </div>
        </div>
        
        {showSkipConfirm && (
          <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-6" onClick={() => setShowSkipConfirm(false)}>
            <div className="bg-slate-800 rounded-2xl p-8 max-w-md border-2 border-red-500" onClick={(e) => e.stopPropagation()}>
              <h2 className="text-2xl font-light text-white text-center mb-4">Skip This Puzzle?</h2>
              <p className="text-slate-300 text-center mb-6">You won't earn any gems for this puzzle.</p>
              
              <div className="flex gap-4">
                <button
                  onClick={() => setShowSkipConfirm(false)}
                  className="flex-1 px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-all duration-300"
                >
                  Cancel
                </button>
                <button
                  onClick={handleSkipPuzzle}
                  className="flex-1 px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-all duration-300"
                >
                  Skip
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  }

  // Word Scramble Puzzle
  if (screen === 'puzzle_word' && currentPuzzle) {
    const totalGems = triviaScore + puzzleScore - gemsSpent;
    
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 flex items-center justify-center p-4">
        <button 
          onClick={handleHomeClick}
          className="absolute top-4 left-4 p-3 bg-gradient-to-br from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 rounded-lg transition-all duration-300 shadow-lg"
        >
          <Home className="w-6 h-6 text-white" />
        </button>
        
        <div className="absolute top-4 right-4">
          <button 
            onClick={() => setShowGemBreakdown(true)}
            className="bg-gradient-to-br from-yellow-500 to-amber-600 px-3 py-2 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 cursor-pointer flex items-center gap-2"
          >
            <span className="text-white text-lg">üíé</span>
            <div className="text-white text-sm font-bold">{totalGems}</div>
          </button>
        </div>
        
        <div className="max-w-2xl w-full space-y-4 mt-20">
          <div className="text-center space-y-3">
            <p className="text-amber-400 text-2xl font-bold mb-3">{currentPuzzle.category}</p>
            <p className="text-white text-lg font-light">Word Scramble Challenge</p>
            <p className="text-slate-400 text-sm">Unscramble the letters!</p>
            {!puzzleFirstAttempt && (
              <p className="text-yellow-400 text-xs mt-2">‚ö†Ô∏è First attempt failed - no gems</p>
            )}
          </div>
          
          <div className="bg-slate-800/50 rounded-xl p-6 text-center space-y-4">
            <div className="text-3xl font-light text-white tracking-widest mb-4">
              {scrambledWord}
            </div>
            
            <input
              type="text"
              value={userWord}
              onChange={(e) => setUserWord(e.target.value.toUpperCase())}
              placeholder="Type your answer..."
              className="w-full px-6 py-3 bg-slate-900 text-white text-center text-xl rounded-lg border-2 border-slate-700 focus:border-blue-500 outline-none"
              autoCapitalize="characters"
              autoComplete="off"
              autoCorrect="off"
            />
            
            <button
              onClick={handleWordSubmit}
              className="w-full px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-lg font-light"
            >
              Submit Answer
            </button>
            
            <div className="space-y-2">
              <button
                onClick={handleHint1}
                disabled={totalGems < 50 || hintLevel >= 1}
                className={`w-full px-4 py-2 rounded-lg text-sm transition-all duration-300 ${
                  totalGems < 50 || hintLevel >= 1
                    ? 'bg-slate-700 text-slate-500 cursor-not-allowed'
                    : 'bg-amber-600 hover:bg-amber-700 text-white'
                }`}
              >
                üí° Hint 1: First Letter (-50 gems) {hintLevel >= 1 ? '‚úì' : ''}
              </button>
              
              {hintLevel >= 1 && (
                <button
                  onClick={handleHint2}
                  disabled={totalGems < 100 || hintLevel >= 2}
                  className={`w-full px-4 py-2 rounded-lg text-sm transition-all duration-300 ${
                    totalGems < 100 || hintLevel >= 2
                      ? 'bg-slate-700 text-slate-500 cursor-not-allowed'
                      : 'bg-amber-600 hover:bg-amber-700 text-white'
                  }`}
                >
                  üí° Hint 2: First 3 Letters (-100 gems) {hintLevel >= 2 ? '‚úì' : ''}
                </button>
              )}
              
              {hintLevel >= 2 && (
                <button
                  onClick={handleHint3}
                  disabled={totalGems < 150 || hintLevel >= 3}
                  className={`w-full px-4 py-2 rounded-lg text-sm transition-all duration-300 ${
                    totalGems < 150 || hintLevel >= 3
                      ? 'bg-slate-700 text-slate-500 cursor-not-allowed'
                      : 'bg-amber-600 hover:bg-amber-700 text-white'
                  }`}
                >
                  üí° Hint 3: All But Last 2 (-150 gems) {hintLevel >= 3 ? '‚úì' : ''}
                </button>
              )}
              
              {hintLevel >= 3 && (
                <button
                  onClick={handleHint4}
                  disabled={totalGems < 200 || hintLevel >= 4}
                  className={`w-full px-4 py-2 rounded-lg text-sm transition-all duration-300 ${
                    totalGems < 200 || hintLevel >= 4
                      ? 'bg-slate-700 text-slate-500 cursor-not-allowed'
                      : 'bg-amber-600 hover:bg-amber-700 text-white'
                  }`}
                >
                  üí° Hint 4: Full Answer (-200 gems) {hintLevel >= 4 ? '‚úì' : ''}
                </button>
              )}
            </div>
            
            <button
              onClick={() => setShowSkipConfirm(true)}
              className="w-full px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm transition-all duration-300"
            >
              ‚è≠Ô∏è Skip Puzzle (Free, 0 gems)
            </button>
          </div>
        </div>
        
        {showSkipConfirm && (
          <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-6" onClick={() => setShowSkipConfirm(false)}>
            <div className="bg-slate-800 rounded-2xl p-8 max-w-md border-2 border-red-500" onClick={(e) => e.stopPropagation()}>
              <h2 className="text-2xl font-light text-white text-center mb-4">Skip This Puzzle?</h2>
              <p className="text-slate-300 text-center mb-6">You won't earn any gems for this puzzle.</p>
              
              <div className="flex gap-4">
                <button
                  onClick={() => setShowSkipConfirm(false)}
                  className="flex-1 px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-all duration-300"
                >
                  Cancel
                </button>
                <button
                  onClick={handleSkipPuzzle}
                  className="flex-1 px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-all duration-300"
                >
                  Skip
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  }

  // Success Screen
  if (screen === 'success') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 flex items-center justify-center p-4">
        <button 
          onClick={handleHomeClick}
          className="absolute top-4 left-4 p-3 bg-gradient-to-br from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 rounded-lg transition-all duration-300 shadow-lg"
        >
          <Home className="w-6 h-6 text-white" />
        </button>
        
        <div className="text-center space-y-8">
          <h2 className="text-5xl font-extralight text-white tracking-wider">
            Solved! ‚úì
          </h2>
          
          {currentPuzzle.type === PUZZLE_TYPES.TILE_FLIP && (
            <div className="max-w-md mx-auto bg-slate-800/50 rounded-xl p-6 border border-slate-700">
              <p className="text-slate-400 text-sm font-light mb-2">
                {currentPuzzle.trivia.q}
              </p>
              <p className="text-white text-2xl font-light">
                {currentPuzzle.trivia.a}
              </p>
            </div>
          )}
          
          {currentPuzzle.type === PUZZLE_TYPES.WORD_SCRAMBLE && (
            <div className="max-w-md mx-auto bg-slate-800/50 rounded-xl p-6 border border-slate-700">
              <p className="text-slate-400 text-sm font-light mb-2">
                {currentPuzzle.category}
              </p>
              <p className="text-white text-2xl font-light">
                {currentPuzzle.answer}
              </p>
            </div>
          )}
        </div>
      </div>
    );
  }

  // Complete Screen
  if (screen === 'complete') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-800 flex items-center justify-center p-6">
        <div className="text-center space-y-8 max-w-2xl">
          <h2 className="text-5xl font-extralight text-white tracking-wider mb-4">
            Complete! üéâ
          </h2>
          
          <div className="bg-slate-800/50 rounded-xl p-8 border border-yellow-400/30">
            <div className="grid grid-cols-2 gap-4 text-white">
              <div>
                <div className="text-3xl font-light">{triviaScore}</div>
                <div className="text-xs text-slate-400">Trivia Correct</div>
              </div>
              <div>
                <div className="text-3xl font-light">{puzzleScore}</div>
                <div className="text-xs text-slate-400">Puzzles Solved</div>
              </div>
            </div>
          </div>
          
          <button
            onClick={() => {
              localStorage.removeItem('oneMoveSave_v4');
              setScreen('home');
              setCurrentPuzzleIndex(0);
              setTriviaScore(0);
              setPuzzleScore(0);
              setGemsSpent(0);
              setPuzzlesSkipped(0);
            }}
            className="px-12 py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all duration-300 text-lg font-light tracking-wide"
          >
            Play Again
          </button>
        </div>
      </div>
    );
  }

  return null;
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<OneMove />);
  </script>
</body>
</html>
